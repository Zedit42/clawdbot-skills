<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° SolArb - Funding Rate Arbitrage</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --text-primary: #e4e4e7;
      --text-secondary: #71717a;
      --accent: #8b5cf6;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --border: #27272a;
      --gradient: linear-gradient(135deg, #8b5cf6, #06b6d4);
    }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 1rem; }
    .logo { display: flex; align-items: center; gap: 0.5rem; }
    .logo-icon { font-size: 1.5rem; }
    .logo h1 { font-size: 1.1rem; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .status { font-size: 0.75rem; color: var(--text-secondary); }
    
    .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 1rem; }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 600; font-size: 0.9rem; }
    .refresh-btn { background: var(--accent); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer; }
    .refresh-btn:disabled { opacity: 0.5; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th { text-align: left; padding: 0.6rem 0.75rem; font-size: 0.65rem; text-transform: uppercase; color: var(--text-secondary); background: var(--bg-secondary); }
    td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); }
    tr:hover td { background: rgba(139, 92, 246, 0.05); }
    tr.selected td { background: rgba(139, 92, 246, 0.15); }
    tr { cursor: pointer; }
    
    .market { font-weight: 600; display: flex; align-items: center; gap: 0.4rem; }
    .market-icon { width: 22px; height: 22px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 700; }
    .rate { font-family: monospace; font-weight: 600; }
    .rate.pos { color: var(--red); }
    .rate.neg { color: var(--green); }
    .badge { font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 4px; }
    .badge.long { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .badge.short { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    
    .simulator { padding: 1rem; }
    .sim-section { margin-bottom: 1rem; }
    .sim-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 0.4rem; }
    .sim-value { font-size: 1.1rem; font-weight: 700; }
    .sim-value.green { color: var(--green); }
    .sim-value.red { color: var(--red); }
    .sim-value.yellow { color: var(--yellow); }
    
    .input-group { margin-bottom: 0.75rem; }
    .input-group label { display: block; font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
    .input-group input, .input-group select { width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; }
    .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--accent); }
    
    .position-box { background: var(--bg-secondary); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; }
    .position-box h4 { font-size: 0.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }
    .position-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem; }
    .position-row span:last-child { font-weight: 600; }
    
    .result-box { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem; text-align: center; }
    .result-box h3 { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .result-box .big { font-size: 1.5rem; font-weight: 700; }
    
    .warning { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--red); border-radius: 8px; padding: 0.75rem; font-size: 0.75rem; color: var(--red); margin-top: 0.75rem; }
    .success { background: rgba(34, 197, 94, 0.1); border: 1px solid var(--green); border-radius: 8px; padding: 0.75rem; font-size: 0.75rem; color: var(--green); margin-top: 0.75rem; }
    
    .note { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.75rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px; }
    .note strong { color: var(--accent); }
    
    .loading { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.5rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .footer { text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.65rem; margin-top: 1rem; }
    .footer a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span class="logo-icon">‚ö°</span>
        <h1>SolArb</h1>
      </div>
      <div class="status" id="lastUpdate">Loading...</div>
    </header>
    
    <div class="main-grid">
      <!-- Left: Rates Table -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Drift Funding Rates (8h)</span>
          <button class="refresh-btn" id="refreshBtn" onclick="fetchRates()">üîÑ Refresh</button>
        </div>
        <div id="tableContent">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
      
      <!-- Right: Simulator -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üßÆ Arbitrage Simulator</span>
        </div>
        <div class="simulator">
          <div class="input-group">
            <label>Select Market (click table row)</label>
            <input type="text" id="selectedMarket" value="SOL" readonly style="background: var(--bg-card);">
          </div>
          
          <div class="input-group">
            <label>Position Size (USD)</label>
            <input type="number" id="positionSize" value="100" min="10" step="10">
          </div>
          
          <div class="input-group">
            <label>Hold Duration</label>
            <select id="duration">
              <option value="8">8 hours (1 period)</option>
              <option value="24" selected>24 hours (3 periods)</option>
              <option value="168">7 days</option>
              <option value="720">30 days</option>
            </select>
          </div>
          
          <div class="position-box">
            <h4>üìà Drift Position</h4>
            <div class="position-row">
              <span>Direction</span>
              <span id="driftDir">Long</span>
            </div>
            <div class="position-row">
              <span>8h Funding</span>
              <span id="driftRate">-0.0146%</span>
            </div>
            <div class="position-row">
              <span>Expected Earn</span>
              <span id="driftEarn" class="rate neg">$0.00</span>
            </div>
          </div>
          
          <div class="position-box">
            <h4>üìâ Flash Trade Hedge</h4>
            <div class="position-row">
              <span>Direction</span>
              <span id="hedgeDir">Short</span>
            </div>
            <div class="position-row">
              <span>8h Rate (est.)</span>
              <span id="flashRate">+0.02%</span>
            </div>
            <div class="position-row">
              <span>Expected Earn</span>
              <span id="hedgeEarn" class="rate neg">$0.00</span>
            </div>
            <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">
              * Flash rates estimated from typical spread
            </div>
          </div>
          
          <div class="position-box">
            <h4>üí∏ Costs</h4>
            <div class="position-row">
              <span>Trading Fees (0.1% √ó 4)</span>
              <span id="tradingFees">$0.40</span>
            </div>
            <div class="position-row">
              <span>Slippage (~0.1%)</span>
              <span id="slippage">$0.20</span>
            </div>
          </div>
          
          <div class="result-box" id="resultBox">
            <h3>NET PROFIT</h3>
            <div class="big" id="netProfit">$0.00</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);" id="netApy">0% APY</div>
          </div>
          
          <div id="profitWarning" class="warning" style="display: none;">
            ‚ö†Ô∏è <strong>Costs exceed profit!</strong> Wait for higher spread or increase position size.
          </div>
          
          <div id="profitSuccess" class="success" style="display: none;">
            ‚úÖ <strong>Profitable trade!</strong> Net positive after fees.
          </div>
          
          <div class="note">
            <strong>ü§ñ Auto-Agent:</strong> When integrated with SolArb agent, positions auto-close if funding rate reverses and expected loss exceeds threshold.
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <a href="https://drift.trade" target="_blank">Drift Protocol</a> ‚Ä¢ 
      <a href="https://flash.trade" target="_blank">Flash Trade</a> ‚Ä¢
      <a href="https://github.com/zedit42/clawdbot-skills" target="_blank">GitHub Repo</a> ‚Ä¢
      <a href="https://clawdhub.com/skills/solana-funding-arb" target="_blank">ClawdHub Skill</a>
    </div>
  </div>
  
  <script>
    const MARKETS = [
      { name: 'SOL-PERP', index: 0 },
      { name: 'BTC-PERP', index: 1 },
      { name: 'ETH-PERP', index: 2 },
      { name: 'ARB-PERP', index: 5 },
      { name: 'DOGE-PERP', index: 6 },
      { name: 'SUI-PERP', index: 8 },
      { name: 'WIF-PERP', index: 13 },
      { name: 'JTO-PERP', index: 14 },
      { name: 'JUP-PERP', index: 17 },
      { name: 'PYTH-PERP', index: 19 },
    ];
    
    let ratesData = [];
    let selectedMarket = 'SOL';
    
    async function fetchRates() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥';
      
      try {
        const results = [];
        
        for (const m of MARKETS) {
          try {
            const resp = await fetch(`https://data.api.drift.trade/fundingRates?marketName=${m.name}`);
            const json = await resp.json();
            const data = Array.isArray(json) ? json : (json.fundingRates || []);
            
            if (data.length > 0) {
              const latest = data[data.length - 1];
              const rawRate = parseInt(latest.fundingRate || '0');
              const rate8h = (rawRate / 1e9) * 100;
              
              results.push({
                market: m.name.replace('-PERP', ''),
                rate8h: rate8h,
                direction: rawRate > 0 ? 'Longs Pay' : rawRate < 0 ? 'Shorts Pay' : 'Neutral',
                earn: rawRate < 0 ? 'Long' : rawRate > 0 ? 'Short' : '-'
              });
            }
          } catch (e) { console.error(e); }
          await new Promise(r => setTimeout(r, 100));
        }
        
        ratesData = results.sort((a, b) => Math.abs(b.rate8h) - Math.abs(a.rate8h));
        renderTable();
        updateSimulator();
        document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
      }
      
      btn.disabled = false;
      btn.textContent = 'üîÑ Refresh';
    }
    
    function renderTable() {
      if (!ratesData.length) {
        document.getElementById('tableContent').innerHTML = '<div class="loading">No data</div>';
        return;
      }
      
      let html = `<table><thead><tr>
        <th>Market</th><th>8h Rate</th><th>Daily</th><th>Earn With</th>
      </tr></thead><tbody>`;
      
      for (const r of ratesData) {
        const cls = r.rate8h < 0 ? 'neg' : 'pos';
        const badge = r.earn === 'Long' ? 'long' : r.earn === 'Short' ? 'short' : '';
        const daily = r.rate8h * 3;
        const sel = r.market === selectedMarket ? 'selected' : '';
        
        html += `<tr class="${sel}" onclick="selectMarket('${r.market}')">
          <td><div class="market"><div class="market-icon">${r.market.slice(0,2)}</div>${r.market}</div></td>
          <td class="rate ${cls}">${r.rate8h >= 0 ? '+' : ''}${r.rate8h.toFixed(4)}%</td>
          <td class="rate ${cls}">${daily >= 0 ? '+' : ''}${daily.toFixed(4)}%</td>
          <td><span class="badge ${badge}">${r.earn}</span></td>
        </tr>`;
      }
      
      html += '</tbody></table>';
      document.getElementById('tableContent').innerHTML = html;
    }
    
    function selectMarket(market) {
      selectedMarket = market;
      document.getElementById('selectedMarket').value = market;
      renderTable();
      updateSimulator();
    }
    
    function updateSimulator() {
      const marketData = ratesData.find(r => r.market === selectedMarket);
      if (!marketData) return;
      
      const posSize = parseFloat(document.getElementById('positionSize').value) || 100;
      const hours = parseInt(document.getElementById('duration').value) || 24;
      const periods = hours / 8;
      
      const driftRate = marketData.rate8h;
      const driftDir = driftRate < 0 ? 'Long' : 'Short';
      const hedgeDir = driftDir === 'Long' ? 'Short' : 'Long';
      
      // Drift earning (if we're on the receiving side)
      const driftEarn = Math.abs(driftRate / 100) * posSize * periods;
      
      // Flash Trade: typically opposite direction, estimate ~30-50% of Drift spread
      const flashRate = Math.abs(driftRate) * 0.4 * (driftRate < 0 ? 1 : -1);
      const hedgeEarn = Math.abs(flashRate / 100) * posSize * periods;
      document.getElementById('flashRate').textContent = (flashRate >= 0 ? '+' : '') + flashRate.toFixed(4) + '%';
      
      // Costs
      const tradingFees = posSize * 0.001 * 4; // 0.1% √ó 4 trades
      const slippage = posSize * 0.001 * 2; // 0.1% √ó 2 (open both)
      const totalCost = tradingFees + slippage;
      
      // Net
      const grossProfit = driftEarn + hedgeEarn;
      const netProfit = grossProfit - totalCost;
      const netApy = (netProfit / posSize) * (8760 / hours) * 100;
      
      // Update UI
      document.getElementById('driftDir').textContent = driftDir;
      document.getElementById('driftRate').textContent = (driftRate >= 0 ? '+' : '') + driftRate.toFixed(4) + '%';
      document.getElementById('driftEarn').textContent = '$' + driftEarn.toFixed(2);
      document.getElementById('driftEarn').className = 'rate neg';
      
      document.getElementById('hedgeDir').textContent = hedgeDir;
      document.getElementById('hedgeEarn').textContent = '$' + hedgeEarn.toFixed(2);
      
      document.getElementById('tradingFees').textContent = '$' + tradingFees.toFixed(2);
      document.getElementById('slippage').textContent = '$' + slippage.toFixed(2);
      
      document.getElementById('netProfit').textContent = (netProfit >= 0 ? '+' : '') + '$' + netProfit.toFixed(2);
      document.getElementById('netProfit').style.color = netProfit >= 0 ? 'var(--green)' : 'var(--red)';
      document.getElementById('netApy').textContent = netApy.toFixed(1) + '% APY';
      
      // Show warning or success
      document.getElementById('profitWarning').style.display = netProfit < 0 ? 'block' : 'none';
      document.getElementById('profitSuccess').style.display = netProfit >= 0 ? 'block' : 'none';
    }
    
    // Event listeners
    document.getElementById('positionSize').addEventListener('input', updateSimulator);
    document.getElementById('duration').addEventListener('change', updateSimulator);
    
    // Init
    fetchRates();
    setInterval(fetchRates, 60000);
  </script>
</body>
</html>
